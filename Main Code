//Libraries
#include <DHT.h> //DHT sensor
#include <SPI.h> //SD card
#include <SD.h> //SD card
#include <Adafruit_seesaw.h> //moisture sensor

//input pin intializiation
const int dhtPin=2; //temperature and humidity sensor pin
const int lightSensorPin=0; //light sensor pin

//output pin intializiation
const int RELAY_ENABLE = 3; //solenoid valve
/*
const int fanPin=???;               //FIX ME
const int lightPin=???;             //FIX ME
*/

//sd card intializiation
File sensorDataFile;

//output device usage tracking
bool actuatedValve=0; //will track if the plants have been watered recently
bool actuatedLight=0; //will track if the plants used a growing light recently
bool actuatedFan=0; //will track if the plants used a fan recently

//other initializations
#define DHTPIN 2 //what pin the DHT sensor is connected to
#define DHTTYPE DHT22 
DHT dht(DHTPIN, DHTTYPE);
Adafruit_seesaw ss;


void setup() {
  pinMode(dhtPin,INPUT);
  pinMode(lightSensorPin,INPUT);
  pinMode(RELAY_ENABLE,OUTPUT);
  /*
  pinMode(fanPin,OUTPUT);
  pinMode(lightPin,OUTPUT);
  */
  dht.begin();
  Serial.begin(9600);
  while (!ss.begin(0x36)) {
    ; //wait for moisture sensor to connect
  } 
  while (!Serial) {
    ; // wait for serial port to connect
  }
  if (!SD.begin(10)) {
  Serial.println("SD card initialization failed.");
  while (1); //while(1) is an infinite loop, it ends when SD intialization succeeds
  }
  sensorDataFile=SD.open("data.txt", FILE_WRITE);
  sensorDataFile.println("Air Temp Sensor, Humidity Sesnor, Light Sensor, Soil Temp Sensor, Soil Moisture");
  sensorDataFile.close();
}

void loop() {
  dataLogging();
  actuation();
  waterDelay();
}

void dataLogging() {
  float airTempVal=dht.readTemperature();
  float humidityVal=dht.readHumidity();
  int lightVal=analogRead(lightSensorPin);
  float soilTempVal=ss.getTemp();
  uint16_t moistVal=ss.touchRead(0);
  sensorDataFile = SD.open("data.txt", FILE_WRITE);
  if (sensorDataFile) {
    Serial.println("Writing to data.txt...");
    sensorDataFile.print("   ");
    sensorDataFile.print(airTempVal);
    sensorDataFile.print("       ,      ");
    sensorDataFile.print(humidityVal);
    sensorDataFile.print("     ,      ");
    sensorDataFile.print(lightVal);
    sensorDataFile.print("     ,      ");
    sensorDataFile.print(soilTempVal);
    sensorDataFile.print("     ,      ");
    sensorDataFile.println(moistVal);
    sensorDataFile.close();
  }else {
    Serial.println("error opening data.txt");  //debugging
  }
}

void actuation(){
  float airTempVal=dht.readTemperature();
  float humidityVal=dht.readHumidity();
  int lightVal=analogRead(lightSensorPin);
  float soilTempVal=ss.getTemp();
  uint16_t moistVal=ss.touchRead(0);
  if(moistVal<800){
    digitalWrite(RELAY_ENABLE, LOW); // The relay is active low, so it turns on when we set the pin to LOW which opens the valve
    delay(1000); //how long should we water the plant or garden?
    digitalWrite(RELAY_ENABLE, HIGH);
    actuatedValve=1;
  }else {
    digitalWrite(RELAY_ENABLE, HIGH);
    actuatedValve=0;
  }
  Serial.print("Temperature: "); Serial.print(soilTempVal); Serial.println("*C");  //debugging
  Serial.print("Capacitive: "); Serial.println(moistVal);                          //debugging
  Serial.print("Actuated"); Serial.println(actuatedValve);  //debugging
  /* 
  if(condition not met for light){         //FIX ME
    digitWrite(lightPin,HIGH);
  } else // this turns off the light
    digitWrite(lightPin,LOW);
  if(condition not met for temperature){   //FIX ME
    digitWrite(fanPin,HIGH);
  } else // this turns off the fan
    digitWrite(fanPin,LOW);
  */
}

void waterDelay(){
  if(actuatedValve=0){
    delay(2000);   //how long should we wait to take measurements again if the plant WAS NOT watered recently?
  }else {
    delay(15000); //how long should we wait to take measurements again if the plant WAS watered recently?
  }
}

/*
--------------------------------------------------
LIGHT SENSOR INFO:

reading of...
less than 10 is dark
10 to 200 is dim
200 to 500 is light
500 to 800 is bright
greater than 800 is very right

--------------------------------------------------
MOISTURE SENSOR INFO:

reading of... 
air is around 350
human touch is around 1000
water is around ???
damp soil is around ???
dry soil is around ???

--------------------------------------------------
DHT SENSOR INFO:

temperature conversion formula: F=(C)(9/5)+32   or  C=(F-32)(5/9)

--------------------------------------------------
 */
